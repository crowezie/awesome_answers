# Implementing a mailer

First of all note that we can run

```
bin/rails g
```

And there is something there called a mailer

We want to build a mailer that sends an email everytime someone submits an answer to your question.

1) So run
```
bin/rails g mailer answers_mailer
```

Generates application mailer and answers mailers

2) in answers_mailer

```ruby
class AnswersMailer < ApplicationMailer
  def notify_question_owner(answer)
  end

end
```

3) And by convention we then create two view files named after the method name

notify_question_owner.html.erb
and
notify_question_owner.text.erb

4) add mailto method to AnswersMailer

```ruby
class AnswersMailer < ApplicationMailer
  def notify_question_owner(answer)
    @answer = answer
    @question = answer.question
    @question_user = @question.user
    mail(to: @question_user.email, subject: "You've got an answer!")
  end
end
```

5) In config initializers (files that only get run once when you first start the server) Create a file called app_keys.rb

6) Tell git to ignore it since we will be adding sensitive information:

```ruby
# See https://help.github.com/articles/ignoring-files for more about ignoring files.
#
# If you find yourself ignoring temporary files generated by your text editor
# or operating system, you probably want to add a global ignore instead:
#   git config --global core.excludesfile '~/.gitignore_global'

# Ignore bundler config.
/.bundle


/config/initializers/app_keys.rb
```

7) In app_keys.rb add the following (ENV used to store global configuration variables in rails)

```ruby
ENV["email_user_name"]
ENV["email_password"]
```

8) Create another new file in initializers called
setup_mail.rb
```ruby
ActionMailer::Base.smtp_settings = {
  address:              "smtp.gmail.com",
  port:                 "587",
  enable_starttls_auto: true,
  authentication:       :plain,
  user_name:            ENV["email_user_name"],
  password:             ENV["email_password"]
}
```

9) Now in views

#### notify_question_owner.html.erb
```erb
<p>Hello  <%= @question_user.first_name %>,</p>
<br>
<p>You've gotten an answer to your question.</p>
<p>The answer is: <%= @answer.body %>.</p>

<p>Regards,</p>
<p> The Awesome Answers Team</p>
```

#### notify_question_owner.text.erb
```
Hello  <%= @question_user.first_name %>,

You've gotten an answer to your question.<
The answer is: <%= @answer.body %>.

Regards,
 The Awesome Answers Team
```

10) Update the answers controller to tell it to send mail

```ruby
def create
  @answer   = Answer.new answer_params
  @question = Question.friendly.find params[:question_id]
  @answer.user = current_user
  @answer.question = @question
  if @answer.save
    AnswersMailer.notify_question_owner(@answer).deliver_now
    redirect_to question_path(@question), notice: "Answer Created!"

  else
    flash[:alert] = "Answer wasn't created"
    # This will render show.html.erb within questions folder (in views)
    # We choose to use render as opposed to redirect_to since otherwise we will loose our errors when the page is refreshed
    render "/questions/show"
  end
end
```

11) Add letter opener gem to your Gemfile in order to
have it just open emails in a browser window which
we want for now since we're just testing in development
and don't want to spam ourselves with many emails

In your gemfile

```ruby
gem "letter_opener", :group => :development
```

```
bundle
```

12) In order to tell Rails to use the letter_opener gem rather than sending regular mail we have to add the following in config/development.rb

```ruby
config.action_mailer.delivery_method = :letter_opener
```

13) If we wanted to use this in production Tam suggests mandrill.com for when you go to production. Allows you to send 2000 emails for free. It's a scalable mailing service
If we want to use mandrill we change the address:. user_name: and password: fields in the setup_mail.rb file based on the fields mandrill will give you.
